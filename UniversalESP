local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local CONFIG = {
    Enabled = true,
    TeamColor = Color3.fromRGB(0, 255, 0),
    EnemyColor = Color3.fromRGB(255, 0, 0),
    NPCColor = Color3.fromRGB(255, 255, 0),
    HighlightTransparency = 0.5,
    OutlineTransparency = 0,
    TextColor = Color3.fromRGB(255, 255, 255),
    TextSize = 14,
    MaxDistance = 1000,
    ShowNames = true,
    ShowTeams = true,
    ShowDistance = true,
    ShowNPCs = false
}

local ESPObjects = {}
local NPCObjects = {}
local Connections = {}

local function isTeammate(player)
    if not LocalPlayer.Team or not player.Team then
        return false
    end
    return LocalPlayer.Team == player.Team
end

local function getTeamColor(player)
    if not player.Team then
        return Color3.fromRGB(255, 255, 255)
    end
    
    if isTeammate(player) then
        return CONFIG.TeamColor
    else
        return CONFIG.EnemyColor
    end
end

local function isPlayerCharacter(model)
    for _, player in pairs(Players:GetPlayers()) do
        if player.Character == model then
            return true
        end
    end
    return false
end

local function createHighlight(character, player, isNPC)
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESPHighlight"
    local color
    if isNPC then
        color = CONFIG.NPCColor
    else
        color = getTeamColor(player)
    end
    highlight.FillColor = color
    highlight.FillTransparency = CONFIG.HighlightTransparency
    highlight.OutlineColor = color
    highlight.OutlineTransparency = CONFIG.OutlineTransparency
    highlight.Enabled = CONFIG.Enabled
    highlight.Parent = character
    return highlight
end

local function createTextLabel(character, player, isNPC)
    local head = character:FindFirstChild("Head")
    if not head then return end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPLabel"
    billboard.Adornee = head
    billboard.Size = UDim2.new(0, 100, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 2, 0)
    billboard.AlwaysOnTop = true
    billboard.Enabled = CONFIG.Enabled
    billboard.Parent = head
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.TextColor3 = CONFIG.TextColor
    textLabel.TextSize = CONFIG.TextSize
    textLabel.TextStrokeTransparency = 0.5
    textLabel.Font = Enum.Font.GothamBold
    textLabel.Parent = billboard
    
    local function updateText()
        local parts = {}
        
        if CONFIG.ShowNames then
            if isNPC then
                table.insert(parts, character.Name)
            else
                table.insert(parts, player.Name)
            end
        end
        
        if CONFIG.ShowTeams then
            if isNPC then
                table.insert(parts, "[NPC]")
            else
                local teamName = player.Team and player.Team.Name or "No Team"
                table.insert(parts, "[" .. teamName .. "]")
            end
        end
        
        if CONFIG.ShowDistance then
            local distance = "?"
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and character:FindFirstChild("HumanoidRootPart") then
                distance = math.floor((LocalPlayer.Character.HumanoidRootPart.Position - character.HumanoidRootPart.Position).Magnitude)
            end
            table.insert(parts, tostring(distance) .. " studs")
        end
        
        textLabel.Text = table.concat(parts, "\n")
    end
    
    updateText()
    return billboard, updateText
end

local function addESP(player)
    if player == LocalPlayer then return end
    
    local character = player.Character
    if not character then return end
    
    if ESPObjects[player] then
        removeESP(player)
    end
    
    local highlight = createHighlight(character, player, false)
    local billboard, updateText = createTextLabel(character, player, false)
    
    ESPObjects[player] = {
        Highlight = highlight,
        Billboard = billboard,
        UpdateText = updateText,
        Character = character,
        Player = player
    }
end

function removeESP(player)
    if ESPObjects[player] then
        if ESPObjects[player].Highlight then
            ESPObjects[player].Highlight:Destroy()
        end
        if ESPObjects[player].Billboard then
            ESPObjects[player].Billboard:Destroy()
        end
        ESPObjects[player] = nil
    end
end

local function addNPCESP(npc)
    if NPCObjects[npc] then
        removeNPCESP(npc)
    end
    
    local highlight = createHighlight(npc, nil, true)
    local billboard, updateText = createTextLabel(npc, nil, true)
    
    NPCObjects[npc] = {
        Highlight = highlight,
        Billboard = billboard,
        UpdateText = updateText,
        Character = npc
    }
end

function removeNPCESP(npc)
    if NPCObjects[npc] then
        if NPCObjects[npc].Highlight then
            NPCObjects[npc].Highlight:Destroy()
        end
        if NPCObjects[npc].Billboard then
            NPCObjects[npc].Billboard:Destroy()
        end
        NPCObjects[npc] = nil
    end
end

local function scanForNPCs()
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and obj:FindFirstChild("Head") then
            if not isPlayerCharacter(obj) and obj ~= LocalPlayer.Character then
                if not NPCObjects[obj] then
                    addNPCESP(obj)
                end
            end
        end
    end
end

local function updateESP(player)
    if not ESPObjects[player] then return end
    
    local color = getTeamColor(player)
    
    if ESPObjects[player].Highlight then
        ESPObjects[player].Highlight.FillColor = color
        ESPObjects[player].Highlight.OutlineColor = color
        ESPObjects[player].Highlight.Enabled = CONFIG.Enabled
    end
    
    if ESPObjects[player].Billboard then
        ESPObjects[player].Billboard.Enabled = CONFIG.Enabled
    end
    
    if ESPObjects[player].UpdateText then
        ESPObjects[player].UpdateText()
    end
end

local function updateNPCESP(npc)
    if not NPCObjects[npc] then return end
    
    if NPCObjects[npc].Highlight then
        NPCObjects[npc].Highlight.FillColor = CONFIG.NPCColor
        NPCObjects[npc].Highlight.OutlineColor = CONFIG.NPCColor
        NPCObjects[npc].Highlight.Enabled = CONFIG.Enabled and CONFIG.ShowNPCs
    end
    
    if NPCObjects[npc].Billboard then
        NPCObjects[npc].Billboard.Enabled = CONFIG.Enabled and CONFIG.ShowNPCs
    end
    
    if NPCObjects[npc].UpdateText then
        NPCObjects[npc].UpdateText()
    end
end

function updateAllESP()
    for player, _ in pairs(ESPObjects) do
        updateESP(player)
    end
    for npc, _ in pairs(NPCObjects) do
        updateNPCESP(npc)
    end
end

local function cleanupAllESP()
    for player, _ in pairs(ESPObjects) do
        removeESP(player)
    end
    for npc, _ in pairs(NPCObjects) do
        removeNPCESP(npc)
    end
    for _, connection in pairs(Connections) do
        connection:Disconnect()
    end
end

local function createNotification()
    local NotifGui = Instance.new("ScreenGui")
    NotifGui.Name = "NotificationGui"
    NotifGui.ResetOnSpawn = false
    NotifGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    
    local NotifFrame = Instance.new("Frame")
    NotifFrame.Size = UDim2.new(0, 400, 0, 180)
    NotifFrame.Position = UDim2.new(0.5, -200, 0.5, -90)
    NotifFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    NotifFrame.BorderSizePixel = 2
    NotifFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
    NotifFrame.Parent = NotifGui
    
    local NotifTitle = Instance.new("TextLabel")
    NotifTitle.Size = UDim2.new(1, 0, 0, 40)
    NotifTitle.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    NotifTitle.BorderSizePixel = 0
    NotifTitle.Text = "Important Message"
    NotifTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    NotifTitle.TextSize = 18
    NotifTitle.Font = Enum.Font.GothamBold
    NotifTitle.Parent = NotifFrame
    
    local NotifText = Instance.new("TextLabel")
    NotifText.Size = UDim2.new(1, -20, 0, 60)
    NotifText.Position = UDim2.new(0, 10, 0, 50)
    NotifText.BackgroundTransparency = 1
    NotifText.Text = "you should totally join this discord server:\ndsc.gg/vadriftz"
    NotifText.TextColor3 = Color3.fromRGB(255, 255, 255)
    NotifText.TextSize = 16
    NotifText.Font = Enum.Font.Gotham
    NotifText.TextWrapped = true
    NotifText.Parent = NotifFrame
    
    local YesButton = Instance.new("TextButton")
    YesButton.Size = UDim2.new(0, 180, 0, 40)
    YesButton.Position = UDim2.new(0, 10, 1, -50)
    YesButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
    YesButton.BorderSizePixel = 0
    YesButton.Text = "fuck yeah"
    YesButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    YesButton.TextSize = 16
    YesButton.Font = Enum.Font.GothamBold
    YesButton.Parent = NotifFrame
    
    local NoButton = Instance.new("TextButton")
    NoButton.Size = UDim2.new(0, 180, 0, 40)
    NoButton.Position = UDim2.new(1, -190, 1, -50)
    NoButton.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
    NoButton.BorderSizePixel = 0
    NoButton.Text = "no wtf?"
    NoButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    NoButton.TextSize = 16
    NoButton.Font = Enum.Font.GothamBold
    NoButton.Parent = NotifFrame
    
    YesButton.MouseButton1Click:Connect(function()
        NotifGui:Destroy()
    end)
    
    NoButton.MouseButton1Click:Connect(function()
        NotifGui:Destroy()
    end)
end

local function createGUI()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "ESPGui"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 300, 0, 500)
    MainFrame.Position = UDim2.new(0.01, 0, 0.3, 0)
    MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    MainFrame.BorderSizePixel = 2
    MainFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Parent = ScreenGui
    
    local Title = Instance.new("TextLabel")
    Title.Name = "Title"
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
    Title.BorderSizePixel = 0
    Title.Text = "ESP Settings"
    Title.TextColor3 = Color3.fromRGB(255, 255, 255)
    Title.TextSize = 18
    Title.Font = Enum.Font.GothamBold
    Title.Parent = MainFrame
    
    local Credit = Instance.new("TextLabel")
    Credit.Name = "Credit"
    Credit.Size = UDim2.new(1, 0, 0, 25)
    Credit.Position = UDim2.new(0, 0, 1, -25)
    Credit.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    Credit.BorderSizePixel = 0
    Credit.Text = "made by vpcir(vinnie)"
    Credit.TextColor3 = Color3.fromRGB(200, 200, 200)
    Credit.TextSize = 12
    Credit.Font = Enum.Font.Gotham
    Credit.Parent = MainFrame
    
    local CloseButton = Instance.new("TextButton")
    CloseButton.Name = "CloseButton"
    CloseButton.Size = UDim2.new(0, 30, 0, 30)
    CloseButton.Position = UDim2.new(1, -35, 0, 5)
    CloseButton.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    CloseButton.BorderSizePixel = 0
    CloseButton.Text = "X"
    CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    CloseButton.TextSize = 16
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Parent = Title
    
    CloseButton.MouseButton1Click:Connect(function()
        cleanupAllESP()
        ScreenGui:Destroy()
    end)
    
    local yPos = 50
    
    local function createToggle(name, defaultValue, callback)
        local ToggleFrame = Instance.new("Frame")
        ToggleFrame.Size = UDim2.new(1, -20, 0, 35)
        ToggleFrame.Position = UDim2.new(0, 10, 0, yPos)
        ToggleFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        ToggleFrame.BorderSizePixel = 0
        ToggleFrame.Parent = MainFrame
        
        local Label = Instance.new("TextLabel")
        Label.Size = UDim2.new(0.6, 0, 1, 0)
        Label.BackgroundTransparency = 1
        Label.Text = name
        Label.TextColor3 = Color3.fromRGB(255, 255, 255)
        Label.TextSize = 14
        Label.Font = Enum.Font.Gotham
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.Position = UDim2.new(0, 10, 0, 0)
        Label.Parent = ToggleFrame
        
        local ToggleButton = Instance.new("TextButton")
        ToggleButton.Size = UDim2.new(0, 50, 0, 25)
        ToggleButton.Position = UDim2.new(1, -60, 0.5, -12.5)
        ToggleButton.BackgroundColor3 = defaultValue and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
        ToggleButton.BorderSizePixel = 0
        ToggleButton.Text = defaultValue and "ON" or "OFF"
        ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        ToggleButton.TextSize = 12
        ToggleButton.Font = Enum.Font.GothamBold
        ToggleButton.Parent = ToggleFrame
        
        local toggled = defaultValue
        ToggleButton.MouseButton1Click:Connect(function()
            toggled = not toggled
            ToggleButton.Text = toggled and "ON" or "OFF"
            ToggleButton.BackgroundColor3 = toggled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
            callback(toggled)
        end)
        
        yPos = yPos + 45
    end
    
    local function createColorPicker(name, defaultColor, callback)
        local ColorFrame = Instance.new("Frame")
        ColorFrame.Size = UDim2.new(1, -20, 0, 35)
        ColorFrame.Position = UDim2.new(0, 10, 0, yPos)
        ColorFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        ColorFrame.BorderSizePixel = 0
        ColorFrame.Parent = MainFrame
        
        local Label = Instance.new("TextLabel")
        Label.Size = UDim2.new(0.5, 0, 1, 0)
        Label.BackgroundTransparency = 1
        Label.Text = name
        Label.TextColor3 = Color3.fromRGB(255, 255, 255)
        Label.TextSize = 14
        Label.Font = Enum.Font.Gotham
        Label.TextXAlignment = Enum.TextXAlignment.Left
        Label.Position = UDim2.new(0, 10, 0, 0)
        Label.Parent = ColorFrame
        
        local RButton = Instance.new("TextButton")
        RButton.Size = UDim2.new(0, 25, 0, 25)
        RButton.Position = UDim2.new(1, -180, 0.5, -12.5)
        RButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
        RButton.Text = "R"
        RButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        RButton.TextSize = 12
        RButton.Font = Enum.Font.GothamBold
        RButton.Parent = ColorFrame
        
        local GButton = Instance.new("TextButton")
        GButton.Size = UDim2.new(0, 25, 0, 25)
        GButton.Position = UDim2.new(1, -150, 0.5, -12.5)
        GButton.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
        GButton.Text = "G"
        GButton.TextColor3 = Color3.fromRGB(0, 0, 0)
        GButton.TextSize = 12
        GButton.Font = Enum.Font.GothamBold
        GButton.Parent = ColorFrame
        
        local BButton = Instance.new("TextButton")
        BButton.Size = UDim2.new(0, 25, 0, 25)
        BButton.Position = UDim2.new(1, -120, 0.5, -12.5)
        BButton.BackgroundColor3 = Color3.fromRGB(0, 0, 255)
        BButton.Text = "B"
        BButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        BButton.TextSize = 12
        BButton.Font = Enum.Font.GothamBold
        BButton.Parent = ColorFrame
        
        local ColorDisplay = Instance.new("Frame")
        ColorDisplay.Size = UDim2.new(0, 80, 0, 25)
        ColorDisplay.Position = UDim2.new(1, -90, 0.5, -12.5)
        ColorDisplay.BackgroundColor3 = defaultColor
        ColorDisplay.BorderSizePixel = 1
        ColorDisplay.BorderColor3 = Color3.fromRGB(255, 255, 255)
        ColorDisplay.Parent = ColorFrame
        
        local currentColor = {defaultColor.R * 255, defaultColor.G * 255, defaultColor.B * 255}
        
        RButton.MouseButton1Click:Connect(function()
            currentColor[1] = (currentColor[1] + 50) % 256
            local newColor = Color3.fromRGB(currentColor[1], currentColor[2], currentColor[3])
            ColorDisplay.BackgroundColor3 = newColor
            callback(newColor)
        end)
        
        GButton.MouseButton1Click:Connect(function()
            currentColor[2] = (currentColor[2] + 50) % 256
            local newColor = Color3.fromRGB(currentColor[1], currentColor[2], currentColor[3])
            ColorDisplay.BackgroundColor3 = newColor
            callback(newColor)
        end)
        
        BButton.MouseButton1Click:Connect(function()
            currentColor[3] = (currentColor[3] + 50) % 256
            local newColor = Color3.fromRGB(currentColor[1], currentColor[2], currentColor[3])
            ColorDisplay.BackgroundColor3 = newColor
            callback(newColor)
        end)
        
        yPos = yPos + 45
    end
    
    createToggle("Enable ESP", CONFIG.Enabled, function(value)
        CONFIG.Enabled = value
        updateAllESP()
    end)
    
    createToggle("Show Names", CONFIG.ShowNames, function(value)
        CONFIG.ShowNames = value
        updateAllESP()
    end)
    
    createToggle("Show Teams", CONFIG.ShowTeams, function(value)
        CONFIG.ShowTeams = value
        updateAllESP()
    end)
    
    createToggle("Show Distance", CONFIG.ShowDistance, function(value)
        CONFIG.ShowDistance = value
        updateAllESP()
    end)
    
    createToggle("Show NPCs", CONFIG.ShowNPCs, function(value)
        CONFIG.ShowNPCs = value
        if value then
            scanForNPCs()
        end
        updateAllESP()
    end)
    
    createColorPicker("Team Color", CONFIG.TeamColor, function(color)
        CONFIG.TeamColor = color
        updateAllESP()
    end)
    
    createColorPicker("Enemy Color", CONFIG.EnemyColor, function(color)
        CONFIG.EnemyColor = color
        updateAllESP()
    end)
    
    createColorPicker("NPC Color", CONFIG.NPCColor, function(color)
        CONFIG.NPCColor = color
        updateAllESP()
    end)
end

for _, player in pairs(Players:GetPlayers()) do
    if player.Character then
        addESP(player)
    end
    
    table.insert(Connections, player.CharacterAdded:Connect(function(character)
        task.wait(0.5)
        addESP(player)
    end))
    
    table.insert(Connections, player:GetPropertyChangedSignal("Team"):Connect(function()
        task.wait(0.1)
        updateESP(player)
    end))
end

table.insert(Connections, Players.PlayerAdded:Connect(function(player)
    table.insert(Connections, player.CharacterAdded:Connect(function(character)
        task.wait(0.5)
        addESP(player)
    end))
    
    table.insert(Connections, player:GetPropertyChangedSignal("Team"):Connect(function()
        task.wait(0.1)
        updateESP(player)
    end))
end))

table.insert(Connections, Players.PlayerRemoving:Connect(function(player)
    removeESP(player)
end))

table.insert(Connections, LocalPlayer:GetPropertyChangedSignal("Team"):Connect(function()
    task.wait(0.1)
    updateAllESP()
end))

table.insert(Connections, Workspace.DescendantAdded:Connect(function(obj)
    if CONFIG.ShowNPCs then
        task.wait(0.3)
        if obj:IsA("Model") and obj:FindFirstChildOfClass("Humanoid") and obj:FindFirstChild("Head") then
            if not isPlayerCharacter(obj) and obj ~= LocalPlayer.Character then
                addNPCESP(obj)
            end
        end
    end
end))

table.insert(Connections, Workspace.DescendantRemoving:Connect(function(obj)
    if NPCObjects[obj] then
        removeNPCESP(obj)
    end
end))

table.insert(Connections, RunService.RenderStepped:Connect(function()
    for player, data in pairs(ESPObjects) do
        if data.UpdateText and data.Character and data.Character:FindFirstChild("HumanoidRootPart") then
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local distance = (LocalPlayer.Character.HumanoidRootPart.Position - data.Character.HumanoidRootPart.Position).Magnitude
                
                local shouldShow = distance <= CONFIG.MaxDistance and CONFIG.Enabled
                
                if data.Billboard then
                    data.Billboard.Enabled = shouldShow
                end
                if data.Highlight then
                    data.Highlight.Enabled = shouldShow
                end
            end
            
            data.UpdateText()
        end
    end
    
    for npc, data in pairs(NPCObjects) do
        if data.UpdateText and data.Character and data.Character:FindFirstChild("HumanoidRootPart") then
            if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local distance = (LocalPlayer.Character.HumanoidRootPart.Position - data.Character.HumanoidRootPart.Position).Magnitude
                
                local shouldShow = distance <= CONFIG.MaxDistance and CONFIG.Enabled and CONFIG.ShowNPCs
                
                if data.Billboard then
                    data.Billboard.Enabled = shouldShow
                end
                if data.Highlight then
                    data.Highlight.Enabled = shouldShow
                end
            end
            
            data.UpdateText()
        end
    end
end))

createNotification()
createGUI()
